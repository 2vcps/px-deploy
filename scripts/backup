aws s3api create-bucket --bucket $BACKUP_BUCKET --region $aws_region --create-bucket-configuration LocationConstraint=$aws_region >/dev/null

BACKUP_POD_NAME=$(kubectl get pods -n portworx -l app=px-backup -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
kubectl cp -n portworx $BACKUP_POD_NAME:pxbackupctl/linux/pxbackupctl /usr/bin/pxbackupctl
chmod +x /usr/bin/pxbackupctl

BACKUP_POD_IP=$(kubectl get pods -n portworx -l app=px-backup -o jsonpath='{.items[*].status.podIP}' 2>/dev/null)
AWS_ACCESS_KEY=$(sed -n 's/aws_access_key_id[ =]*//p' /root/.aws/credentials 2>/dev/null)
AWS_SECRET_KEY=$(sed -n 's/aws_secret_access_key[ =]*//p' /root/.aws/credentials 2>/dev/null)
pxbackupctl create cloudcredential --aws-access-key $AWS_ACCESS_KEY --aws-secret-key $AWS_SECRET_KEY -e $BACKUP_POD_IP:10002 --orgID portworx -n s3 -p aws
sleep 5
pxbackupctl create backuplocation -c s3 -n aws -p s3 --s3-endpoint https://s3.$aws_region.amazonaws.com --path $BACKUP_BUCKET --s3-region $aws_region -e $BACKUP_POD_IP:10002 --orgID portworx
pxbackupctl create schedulepolicy --interval-minutes 15 --interval-retain 12 --name example-schedule -e $BACKUP_POD_IP:10002 --orgID portworx
