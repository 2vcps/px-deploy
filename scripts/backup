while : ; do
  n=$(kubectl get node  | grep -i ready | awk '{print$1}' | xargs kubectl get node  -o=jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.taints}{"\n"}{end}' | grep -iv noschedule | wc -l 2>&1)
  [ $n -ge 3 ] && break
  sleep 1
  echo Waiting for Kubernetes cluster to come up
done
if [ $cluster = 1 ]; then
    IP=$(curl https://ipinfo.io/ip)
    curl -o /root/install.sh 'https://raw.githubusercontent.com/portworx/px-central-onprem/1.0.1/install.sh'
    sh /root/install.sh --all --license-password 'Adm1n!Ur' --kubeconfig /root/.kube/config --pxcentral-endpoint $IP
fi
if [ $cluster != 1 ]; then
    k8s_version=$(kubectl version --short | awk -Fv '/Server Version: / {print $3}')
    url="https://install.portworx.com/$px_version?kbver=$k8s_version&b=true&c=px-deploy-$cluster&stork=true&st=k8s&lh=true"
    curl -so /tmp/px.yml $url
    kubectl apply -f /tmp/px.yml
fi
if [ $cluster = 2 ]; then
    kubectl apply -f /assets/sock-shop/sock-shop.yaml
    kubectl apply -f /assets/petclinic/petclinic-with-namespace.yml
fi