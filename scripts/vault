IPADDR=$(hostname -i)
VERSION=1.6.3

echo "Fetching Vault..."
cd /tmp
curl -sLo vault.zip https://releases.hashicorp.com/vault/${VERSION}/vault_${VERSION}_linux_amd64.zip

echo "Installing Vault..."
unzip vault.zip >/dev/null
chmod +x vault
mv vault /usr/local/bin/vault

# Setup Vault
mkdir -p /tmp/vault-data
mkdir -p /etc/vault.d
cat >/etc/vault.d/config.json <<EOF
ui = true
storage "file" {
  path = "/tmp/vault-data"
}

listener "tcp" {
 address     = "${IPADDR}:8200"
 tls_disable = "true"
}
EOF

cat >/etc/systemd/system/vault.service <<EOF
[Unit]
Description = "Vault"

[Service]
# Stop vault will not mark node as failed but left
KillSignal=INT
ExecStart=/usr/local/bin/vault server -config=/etc/vault.d/config.json
Restart=always
ExecStopPost=/bin/sleep 5
EOF

echo "Starting Vault..."
systemctl daemon-reload
systemctl enable vault
systemctl start vault
