exec &>/var/log/px-deploy/k8s-node
dnf install -y kubelet-$k8s_version-0 docker
dnf install -y kubeadm-$k8s_version-0 kubectl-$k8s_version-0
systemctl enable docker kubelet
systemctl restart docker kubelet
kubeadm config images list --kubernetes-version $k8s_version | xargs -n1 -P0 docker pull
while : ; do
  command=$(ssh -oConnectTimeout=1 -oStrictHostKeyChecking=no master-$cluster kubeadm token create --print-join-command)
  echo $command | grep -qE '[0-9a-f]{64}'
  [ $? -eq 0 ] && break
  sleep 5
done
echo "Executing '$command'"
eval $command
