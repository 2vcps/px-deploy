eval $(ssh-agent)
cd /tmp
curl -sO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$ocp4_version/openshift-install-linux-$ocp4_version.tar.gz
curl -sO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$ocp4_version/openshift-client-linux-$ocp4_version.tar.gz
tar xzf openshift-install-linux-$ocp4_version.tar.gz
tar xzf openshift-client-linux-$ocp4_version.tar.gz
mv openshift-install oc kubectl /usr/bin
rm -f openshift-install-linux-$ocp4_version.tar.gz openshift-client-linux-$ocp4_version.tar.gz

mkdir /root/ocp4
cd /root/ocp4
cat <<EOF >install-config.yaml
apiVersion: v1
baseDomain: $ocp4_domain
compute:
- hyperthreading: Enabled
  name: worker
  platform:
    aws:
      type: t2.xlarge
  replicas: $nodes
controlPlane:
  hyperthreading: Enabled
  name: master
  platform: {}
  replicas: 3
metadata:
  creationTimestamp: null
  name: $name
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  machineCIDR: 10.0.0.0/16
  networkType: OpenShiftSDN
  serviceNetwork:
  - 172.30.0.0/16
platform:
  aws:
    region: $aws_region
pullSecret: '$ocp4_pull_secret'
sshKey: |
EOF
echo -n "  " >>install-config.yaml
ssh-keygen -y -f /root/.ssh/id_rsa >>install-config.yaml
openshift-install create cluster --log-level=debug
mkdir /root/.kube
cp /root/ocp4/auth/kubeconfig /root/.kube/config
